@model IEnumerable<PawMates.Core.Models.PostViewModels.PostViewInfoModel>

<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<body class="home-page">
    <div class="text-center row" id="postsContainer">
        @foreach (var p in Model)
        {
            <div class="card post-custom-css" style="width: 30rem; height: 30rem; align-self = center;">
                <div class="card-body">
                    <h6 style="text-align:left;"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="profile-icon"><!--!Font Awesome Free 6.6.0 by fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M304 128a80 80 0 1 0 -160 0 80 80 0 1 0 160 0zM96 128a128 128 0 1 1 256 0A128 128 0 1 1 96 128zM49.3 464l349.5 0c-8.9-63.3-63.3-112-129-112l-91.4 0c-65.7 0-120.1 48.7-129 112zM0 482.3C0 383.8 79.8 304 178.3 304l91.4 0C368.2 304 448 383.8 448 482.3c0 16.4-13.3 29.7-29.7 29.7L29.7 512C13.3 512 0 498.7 0 482.3z" /></svg> @p.Creator</h6>
                    <img class="card-img-top img-post-custom" src="@p.ImageUrl" alt="Card image cap" style="height:230px; object-fit: cover; object-position: 25% 25%;">
                    <h5 class="card-title">Description: </h5>
                    <p class="card-text">@p.Description</p>

                </div>

                @if (User.Identity.Name == p.Creator)
                {
                    <a asp-controller="Post" asp-action="Delete" asp-route-id="@p.Id" class="btn btn-delete mb-2 w-100 p-3 fw-bold">Delete</a>
                }
                else
                {
                    <div class="like-div">
                        <a asp-controller="Post" asp-action="Update" asp-route-id="@p.Id"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="like-btn profile-icon"><!--!Font Awesome Free 6.6.0 by fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M225.8 468.2l-2.5-2.3L48.1 303.2C17.4 274.7 0 234.7 0 192.8l0-3.3c0-70.4 50-130.8 119.2-144C158.6 37.9 198.9 47 231 69.6c9 6.4 17.4 13.8 25 22.3c4.2-4.8 8.7-9.2 13.5-13.3c3.7-3.2 7.5-6.2 11.5-9c0 0 0 0 0 0C313.1 47 353.4 37.9 392.8 45.4C462 58.6 512 119.1 512 189.5l0 3.3c0 41.9-17.4 81.9-48.1 110.4L288.7 465.9l-2.5 2.3c-8.2 7.6-19 11.9-30.2 11.9s-22-4.2-30.2-11.9zM239.1 145c-.4-.3-.7-.7-1-1.1l-17.8-20-.1-.1s0 0 0 0c-23.1-25.9-58-37.7-92-31.2C81.6 101.5 48 142.1 48 189.5l0 3.3c0 28.5 11.9 55.8 32.8 75.2L256 430.7 431.2 268c20.9-19.4 32.8-46.7 32.8-75.2l0-3.3c0-47.3-33.6-88-80.1-96.9c-34-6.5-69 5.4-92 31.2c0 0 0 0-.1 .1s0 0-.1 .1l-17.8 20c-.3 .4-.7 .7-1 1.1c-4.5 4.5-10.6 7-16.9 7s-12.4-2.5-16.9-7z" /></svg></a>
                        <p class="like-numbers" id="likeCount_@p.Id">@p.Likes</p> <!-- Assuming you have a property named LikeCount in your model -->
                    </div>
                }
            </div>
        }
    </div>
    <a asp-controller="Post" asp-action="Add" class="material-symbols-outlined floating-btn">Add</a>

    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        history.scrollRestoration = "manual";
        $(window).on('beforeunload', function () {
            $(window).scrollTop(0);
        });

        $(document).ready(function () {
            let page = 2; // Track which page of data to load
            let isLoading = false; // Flag to prevent multiple simultaneous requests

            // Function to load more posts
            function loadMorePosts() {
                if (isLoading) return; // If already loading, exit
                isLoading = true; // Set loading flag

                if (@PawMates.Infrastructure.Data.DataConstants.DataConstants.MaxPage > page - 1) {
                    // AJAX request to fetch more posts from the server
                    $.ajax({
                        url: 'https://localhost:7181/Post/All?page=' + page,
                        method: 'GET',
                        success: function (response) {

                            const temp = new DOMParser().parseFromString(response, "text/html");

                            //$('#postsContainer').append(response);
                            document.getElementById('postsContainer').innerHTML = temp.getElementById('postsContainer').innerHTML;

                            console.log(document.getElementById('postsContainer').innerHTML)
                            page++; // Increment page count for next request
                            isLoading = false; // Reset loading flag
                        },
                        error: function (xhr, status, error) {
                            console.error('Error loading more posts:', error);
                            isLoading = false; // Reset loading flag even on error
                        }
                    });

                }
            }



            // Detect when user scrolls to the bottom of the page
            $(window).scroll(function () {
                if ($(window).scrollTop() + $(window).height() >= $(document).height()) {
                    loadMorePosts(); // Load more posts when user reaches the bottom
                }
            });
        });



        //  function likePost(postId) {
        //      $.ajax({
        //          url: `https://localhost:7181/Post/Update/${postId}`, // URL of your Update action method
        //          type: 'GET',
        //          //data: "_METHOD=PUT"
        //          statusCode: {
        //              204: function (data) {
        //                  console.log('204');
        //                  document.getElementById(`likeCount_${postId}`);
        //                  console.log(Number(document.getElementById(`likeCount_${postId}`).textContent.split(' ')[1]) + 1)
        //              },
        //          },
        //          error: function (xhr, status, error) {
        //              console.error('Error liking post:', error);
        //          }
        //      });
        //  }
    </script>

</body>
